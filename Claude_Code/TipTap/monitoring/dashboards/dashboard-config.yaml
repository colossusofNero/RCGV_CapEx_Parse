# TipTap Production Monitoring Dashboard Configuration
# This configuration file defines monitoring dashboards for TipTap production environment

version: "1.0"
namespace: "tiptap-production"

dashboards:
  # Payment Success Rates Dashboard
  payment_metrics:
    title: "Payment Success Rates"
    description: "Monitor payment success rates across all payment methods"
    refresh_interval: "30s"
    time_range: "1h"
    panels:
      - type: "stat"
        title: "Overall Success Rate"
        query: |
          (sum(rate(payment_success_total[5m])) / sum(rate(payment_attempts_total[5m]))) * 100
        unit: "percent"
        thresholds:
          - value: 95
            color: "green"
          - value: 90
            color: "yellow"
          - value: 0
            color: "red"

      - type: "graph"
        title: "Success Rate by Payment Method"
        query: |
          (sum(rate(payment_success_total[5m])) by (payment_method) /
           sum(rate(payment_attempts_total[5m])) by (payment_method)) * 100
        legend: "{{payment_method}}"
        series:
          - name: "NFC"
            color: "#1f77b4"
          - name: "QR"
            color: "#ff7f0e"
          - name: "Card"
            color: "#2ca02c"
          - name: "ACH"
            color: "#d62728"

      - type: "table"
        title: "Payment Method Breakdown (Last 24h)"
        query: |
          sum by (payment_method) (increase(payment_attempts_total[24h]))
        columns:
          - field: "payment_method"
            title: "Method"
          - field: "value"
            title: "Total Attempts"
            format: "number"

  # Transaction Performance Dashboard
  transaction_performance:
    title: "Transaction Performance"
    description: "Monitor average transaction processing times"
    refresh_interval: "30s"
    time_range: "1h"
    panels:
      - type: "stat"
        title: "Average Transaction Time"
        query: |
          histogram_quantile(0.50, sum(rate(transaction_duration_seconds_bucket[5m])) by (le))
        unit: "seconds"
        thresholds:
          - value: 2
            color: "green"
          - value: 5
            color: "yellow"
          - value: 10
            color: "red"

      - type: "graph"
        title: "Transaction Time Percentiles"
        queries:
          - query: |
              histogram_quantile(0.50, sum(rate(transaction_duration_seconds_bucket[5m])) by (le))
            legend: "50th percentile"
          - query: |
              histogram_quantile(0.95, sum(rate(transaction_duration_seconds_bucket[5m])) by (le))
            legend: "95th percentile"
          - query: |
              histogram_quantile(0.99, sum(rate(transaction_duration_seconds_bucket[5m])) by (le))
            legend: "99th percentile"

      - type: "heatmap"
        title: "Transaction Time Distribution"
        query: |
          sum(rate(transaction_duration_seconds_bucket[5m])) by (le)

  # User Activity Dashboard
  user_activity:
    title: "User Activity & Tip Volume"
    description: "Monitor daily active users and tip volume metrics"
    refresh_interval: "1m"
    time_range: "24h"
    panels:
      - type: "stat"
        title: "Daily Active Users"
        query: |
          count(count by (user_id) (increase(user_activity_total[24h])))
        unit: "users"

      - type: "stat"
        title: "Total Tip Volume (24h)"
        query: |
          sum(increase(tip_amount_total[24h]))
        unit: "currency"

      - type: "graph"
        title: "Hourly Active Users"
        query: |
          count(count by (user_id) (increase(user_activity_total[1h])))

      - type: "graph"
        title: "Hourly Tip Volume"
        query: |
          sum(increase(tip_amount_total[1h]))
        unit: "currency"

      - type: "pie"
        title: "Tips by Amount Range"
        queries:
          - query: |
              sum(increase(tips_by_amount_bucket{le="5"}[24h]))
            legend: "$0-$5"
          - query: |
              sum(increase(tips_by_amount_bucket{le="10"}[24h])) - sum(increase(tips_by_amount_bucket{le="5"}[24h]))
            legend: "$5-$10"
          - query: |
              sum(increase(tips_by_amount_bucket{le="25"}[24h])) - sum(increase(tips_by_amount_bucket{le="10"}[24h]))
            legend: "$10-$25"
          - query: |
              sum(increase(tips_by_amount_total[24h])) - sum(increase(tips_by_amount_bucket{le="25"}[24h]))
            legend: "$25+"

  # Error Monitoring Dashboard
  error_monitoring:
    title: "Error Rates & System Health"
    description: "Monitor application errors and system health metrics"
    refresh_interval: "30s"
    time_range: "1h"
    panels:
      - type: "stat"
        title: "Overall Error Rate"
        query: |
          (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100
        unit: "percent"
        thresholds:
          - value: 1
            color: "red"
          - value: 0.5
            color: "yellow"
          - value: 0
            color: "green"

      - type: "graph"
        title: "Error Rate by Feature"
        query: |
          (sum(rate(feature_errors_total[5m])) by (feature) /
           sum(rate(feature_requests_total[5m])) by (feature)) * 100
        legend: "{{feature}}"

      - type: "table"
        title: "Top Error Messages (Last 1h)"
        query: |
          topk(10, sum by (error_message) (increase(error_logs_total[1h])))
        columns:
          - field: "error_message"
            title: "Error Message"
          - field: "value"
            title: "Count"

      - type: "graph"
        title: "API Response Times"
        queries:
          - query: |
              histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, endpoint))
            legend: "{{endpoint}} - 50th"
          - query: |
              histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, endpoint))
            legend: "{{endpoint}} - 95th"

  # Geographic Distribution Dashboard
  geographic_distribution:
    title: "Geographic Distribution"
    description: "Monitor user activity and transactions by geographic location"
    refresh_interval: "1m"
    time_range: "24h"
    panels:
      - type: "map"
        title: "Active Users by Location"
        query: |
          sum by (geo_region) (increase(user_activity_total[24h]))

      - type: "table"
        title: "Top Regions by Transaction Volume"
        query: |
          topk(10, sum by (geo_region) (increase(transaction_count_total[24h])))
        columns:
          - field: "geo_region"
            title: "Region"
          - field: "value"
            title: "Transactions"

      - type: "graph"
        title: "Transaction Volume by Region (24h)"
        query: |
          sum by (geo_region) (increase(tip_amount_total[24h]))

      - type: "heatmap"
        title: "Peak Hours by Region"
        query: |
          sum by (geo_region, hour) (increase(transaction_count_total[1h]))

# Global dashboard settings
global:
  theme: "dark"
  timezone: "UTC"
  auto_refresh: true
  shared_crossfilter: true

# Template variables for dynamic filtering
variables:
  - name: "environment"
    type: "query"
    query: "label_values(up, environment)"
    default: "production"

  - name: "region"
    type: "query"
    query: "label_values(up, region)"
    default: "all"

  - name: "payment_method"
    type: "custom"
    options: ["all", "nfc", "qr", "card", "ach"]
    default: "all"